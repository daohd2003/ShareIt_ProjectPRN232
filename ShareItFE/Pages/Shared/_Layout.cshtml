@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@RenderSection("Styles", required: false)
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - ShareIt</title>
    <script>
        const apiRootUrl = '@Configuration["ApiSettings:RootUrl"]';
    </script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/ShareItFE.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/chatbot.css" />
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
</head>
<body>
    @await Component.InvokeAsync("Header")
    <main role="main" class="main-content-area">
        @RenderBody()
    </main>
    <footer class="main-footer">
        <div class="max-width-container">
            <div class="footer-grid">
                <div class="footer-brand-section">
                    <div class="footer-brand-logo-group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="footer-brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6.7,16.2l-2.8,2.8a1,1,0,0,0,0,1.4l7.1,7.1a1,1,0,0,0,1.4,0l7.1-7.1a1,1,0,0,0,0-1.4l-2.8-2.8" />
                            <path d="M8.1,14.8,3,20H21l-5.1-5.2" />
                            <path d="M12,2a4,4,0,0,0-4,4v2.4a4,4,0,0,0,8,0V6A4,4,0,0,0,12,2Z" />
                            <line x1="10" y1="12" x2="14" y2="12" />
                        </svg>
                        <span class="footer-brand-name">RentChic</span>
                    </div>
                    <p class="footer-description">
                        Premium fashion rentals for every special occasion. Look amazing, save money, stay sustainable.
                    </p>
                    <div class="footer-social-links">
                        <a href="#" aria-label="Instagram">
                            <svg xmlns="http://www.w3.org/2000/svg" class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                        </a>
                        <a href="#" aria-label="Facebook">
                            <svg xmlns="http://www.w3.org/2000/svg" class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                        </a>
                        <a href="#" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.4 3 4c2.5 2.1 5.8 4.5 9 4.6v.01c0-2 1.5-3.6 3.4-3.6 1.9 0 3.5 1.5 3.5 3.5 0 .2 0 .5-.1.7 3.3-1.6 5.9-3.7 7.1-5.9z"></path></svg>
                        </a>
                        <a href="#" aria-label="Email">
                            <svg xmlns="http://www.w3.org/2000/svg" class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </a>
                    </div>
                </div>
                <div>
                    <h3 class="footer-column-title">Quick Links</h3>
                    <ul class="footer-link-list">
                        <li><a asp-page="/Products/Products" class="footer-link">Browse Collection</a></li>
                        <li><a href="/Index#how-it-works" class="footer-link">How It Works</a></li>
                        <li><a href="#" class="footer-link">Size Guide</a></li>
                        <li><a href="#" class="footer-link">Care Instructions</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="footer-column-title">Categories</h3>
                    <ul class="footer-link-list">
                        <li><a href="/products?category=wedding" class="footer-link">Wedding Dresses</a></li>
                        <li><a href="/products?category=evening" class="footer-link">Evening Gowns</a></li>
                        <li><a href="/products?category=cocktail" class="footer-link">Cocktail Dresses</a></li>
                        <li><a href="/products?category=formal" class="footer-link">Formal Suits</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="footer-column-title">Support</h3>
                    <ul class="footer-link-list">
                        <li><a href="#" class="footer-link">Contact Us</a></li>
                        <li><a href="#" class="footer-link">FAQ</a></li>
                        <li><a href="#" class="footer-link">Returns</a></li>
                        <li><a href="#" class="footer-link">Shipping Info</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom-bar">
                <p>&copy; 2025 RentChic. All rights reserved. | Privacy Policy | Terms of Service</p>
            </div>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/notification.js" asp-append-version="true"></script>

    <script src="~/js/dist/browser/signalr.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Xử lý menu người dùng
            const userMenuButton = document.getElementById('userMenuButton');
            const userMenuDropdown = document.getElementById('userMenuDropdown');

            if (userMenuButton && userMenuDropdown) {
                userMenuButton.addEventListener('click', function (event) {
                    event.stopPropagation();
                    const isHidden = userMenuDropdown.style.display === 'none' || userMenuDropdown.style.display === '';
                    userMenuDropdown.style.display = isHidden ? 'block' : 'none';
                });
            }

            // Xử lý menu di động
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const menuIconOpen = document.getElementById('menuIconOpen');
            const menuIconClose = document.getElementById('menuIconClose');

            if (mobileMenuButton && mobileMenu && menuIconOpen && menuIconClose) {
                mobileMenuButton.addEventListener('click', function () {
                    const isMenuOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isMenuOpen ? 'none' : 'block';
                    menuIconOpen.style.display = isMenuOpen ? 'block' : 'none';
                    menuIconClose.style.display = isMenuOpen ? 'none' : 'block';
                });
            }

            // Đóng dropdown khi click ra ngoài
            window.addEventListener('click', function (event) {
                if (userMenuDropdown && userMenuDropdown.style.display === 'block') {
                    if (!userMenuButton.contains(event.target)) {
                        userMenuDropdown.style.display = 'none';
                    }
                }
            });

            // START: Thêm code cho SignalR Real-time Notification
            // Logic này sẽ được thực thi sau khi trang đã tải xong
            const notificationMenu = document.querySelector('.notification-menu');
            if (notificationMenu) {
                const userId = notificationMenu.getAttribute('data-userid');

                if (userId) {
                    // 1. Khởi tạo kết nối đến SignalR Hub
                    const connection = new signalR.HubConnectionBuilder()
                        .withUrl(apiRootUrl + "/notificationHub")
                        .withAutomaticReconnect()
                        .build();

                    // 2. Lắng nghe sự kiện 'ReceiveNotification' từ server
                    connection.on("ReceiveNotification", (message) => {
                        console.log("Real-time notification received: ", message);

                        // Đây là nơi bạn cập nhật giao diện
                        // Ví dụ: làm cho biểu tượng chuông hiện số thông báo mới
                        const notificationCountSpan = document.getElementById('notificationCount');
                        if (notificationCountSpan) {
                            notificationCountSpan.style.display = 'flex';
                            let currentCount = parseInt(notificationCountSpan.innerText) || 0;
                            notificationCountSpan.innerText = currentCount + 1;
                        }

                        // Bạn cũng có thể gọi một hàm từ notification.js để tải lại danh sách thông báo
                        if (window.loadNotifications) {
                            window.loadNotifications(userId);
                        }
                    });

                    // 3. Bắt đầu kết nối và tham gia vào nhóm của người dùng
                    async function startSignalR() {
                        try {
                            await connection.start();
                            console.log("SignalR Connected.");
                            // Gọi phương thức trên Hub để tham gia nhóm thông báo riêng
                            await connection.invoke("JoinCustomerNotificationGroup", userId);
                            console.log(`User ${userId} has joined their notification group.`);
                        } catch (err) {
                            console.error("SignalR Connection Error: ", err);
                            // Thử lại sau 5 giây nếu kết nối thất bại
                            setTimeout(startSignalR, 5000);
                        }
                    }

                    startSignalR();
                }
            }
            // END: Thêm code cho SignalR Real-time Notification
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>